/*
 * Copyright (c) 2015, Daliworks. All rights reserved.
 *
 * Reproduction and/or distribution in source and binary forms 
 * without the written consent of Daliworks, Inc. is prohibited.
 *
 */
!function(a,b){function c(b,d){var e,f;if("."!=b[0]&&"/"!=b[0])return a(b);if(d=d||"root",e=c.resolve(b),!e&&/\.json$/i.test(b))return a("./"+c.basename(b));if(f=c.cache[e],!f)throw Error('failed to require "'+b+'" from '+d);return f.exports||(f.exports={},f.call(f.exports,f,f.exports,c.relative(e))),f.exports}c.cache={},c.basename=a("path").basename,c.resolve=function(b){var d,e,f;if("."!=b[0])return a.resolve(b);for(d=[b,b+".js",b+"/index.js",b+".json",b+"/index.json"],e=0;f=d[e];e++)if(c.cache[f])return f},c.register=function(a,b){c.cache[a]=b},c.relative=function(a){function b(b){var d,e,f,g,h;if("."!=b[0])return c(b);for(d=a.split("/"),e=b.split("/"),d.pop(),f=0,g=e.length;g>f;f+=1)h=e[f],".."==h?d.pop():"."!=h&&d.push(h);return c(d.join("/"),a)}return b.resolve=c.resolve,b.cache=c.cache,b},c.register("./app.js",function(a,b,c){"use strict";var j,k,l,m,n,o,p,q,r,A,B,C,G,I,J,K,L,M,N,O,d=c("optimist"),e=c("async"),f=c("log4js"),g=c("os"),h=c("config"),i=c("dgram"),s=c("./routes"),t=c("./gateway"),u=c("./server"),v=c("./sensors"),w=c("./utils"),x=c("./store"),y=c("./mqtt"),z=c("./remotecontroller"),D=!1,E=d.usage("Sensorjs app",{logger:{description:"logger configuration json","default":__dirname+"/logger_cfg.json",alias:"l",string:!0},help:{description:"print help",alias:"h"}}).argv,F=process.env.NODE_ENV||"development";E.h&&(d.showHelp(),process.exit(0)),f.configure(E.logger,{reloadSecs:30,cwd:h.Gateway.logBaseDir}),G=f.getLogger("Main"),G.info("... Starting [%s] ...",g.hostname());try{j=c("memwatch")}catch(H){G.warn("MODULES_NOT_SUPPORTED - memwatch")}try{A=c("sensorjs/lib/sensor/driver/rgbLed")}catch(H){G.warn("MODULES_NOT_SUPPORTED - rgbLed")}I=A&&new A({device:{address:66},model:"rgbLed",id:"redLed-66"}),J=A&&new A({device:{address:68},model:"rgbLed",id:"greenLed-68"}),K=A&&new A({device:{address:69},model:"rgbLed",id:"yellowLed-69"}),setTimeout(function(){D?G.info("[init check] initialized OK"):(G.fatal("[init check] restart due to NOT being initialized within ",h.Init.timeout),z.process("restart"))},h.Init.timeout),h.Init.disableUI||(k=c("express"),l=c("errorhandler"),m=c("body-parser"),n=c("multer"),o=c("method-override"),p=c("serve-favicon"),q=c("morgan"),r=c("http-auth"),L=k(),L.set("port",h.Gateway.port||80),L.set("views",__dirname+"/da_views"),L.set("view engine","jade"),L.set("root",__dirname),L.use(p(__dirname+"/../device_ui/app/favicon.ico")),L.use(q("dev")),L.use(m()),L.use(o()),L.get("/api/gateway/ping",function(a,b){D?b.end():b.send(503,"gateway not ready")}),L.use(r.connect(r.digest({realm:"Sensor.js"},function(a,b){b(h.Auth[a])}))),L.use(k.static(__dirname+"/../device_ui/app")),L.use(n({inMemory:!0,limits:{fields:5,files:1,fileSize:1e5}})),L.get("/api/gateway/info",s.gatewayInfo()),L.put("/api/gateway/config",s.gatewayConfig()),L.get("/api/gateway/control",s.gatewayControl()),L.get("/api/server/info",s.serverInfo()),L.get("/api/software/info",s.softwareInfo()),L.get("/api/sensor/data",s.sensorData()),L.get("/api/sensor/discover",s.sensorDiscover()),L.get("/api/sensors/:id",s.getSensorItem()),L.delete("/api/sensors/:id",s.delSensorItem()),L.post("/api/sensor/register",s.postSensorItem()),L.post("/api/certUpload",s.certUpload()),L.post("/api/apikeyUpload",s.apikeyUpload()),L.get("/api/apikey",s.getApikey()),L.get("/api/interfaces",s.getInterfaces()),L.get("/api/interfaces/:id",s.getInterfaceItem()),L.get("/api/modems",s.getModems()),L.get("/api/modems/:id",s.getModemItem()),L.put("/api/modems/:id",s.putModemItem()),L.get("/api/modem/stats",s.getModemStats()),L.post("/api/chpasswd",s.chPasswd()),L.post("/api/actuator/control",s.controlActuator()),L.get("/api/sensorDrivers",s.getSensorDrivers()),"development"===F&&L.use(l({dumpExceptions:!0}))),I&&I.blink(),e.series([function(a){G.info("1. get mac");var b=process.env.GATEWAY_ID;b?(B=w.getSafeId(b),G.info("[get mac from ENV]",B),a()):w.getId("mac",function(b,c){!b&&c?(B=c,a()):a(Error("failure to get id"))})},function(a){G.info("2. store init"),x.init(a)},function(a){var b,c;G.info("3. mqtt init"),b=h.Server.mqtt;try{c="mqtts"===b.protocol?{caPath:h.Gateway.CA_FILE_PATH,rejectUnauthorized:!0}:null,process.env.APIKEY&&h.Server.APIKEY!==process.env.APIKEY&&(h.Server.APIKEY=process.env.APIKEY),C=h.Server.APIKEY,c&&(C?(c.username=B,c.password=C):(c.pfxPath=h.Gateway.CERT_FILE_PATH,c.passphrase=B)),y.init(parseInt(b.port,10)||1883,b.host,B,c,x,function(b){return b&&G.error("mqtt.init() "+b.stack),a()})}catch(d){return G.error("mqtt.init exception=",d),a()}},function(a){G.info("4. server init");var b={password:C};try{u.init(B,b,a)}catch(c){return a()}},function(a){G.info("5. gateway init");try{t.init(B,a)}catch(b){return a(b)}},function(a){G.info("6. sensor init");try{v.init(a)}catch(b){return a(b)}}],function(a){a?(G.fatal("init error",a),setTimeout(function(){z.process("restart")},3e4)):I&&I.on(),h.Init.disableUI?G.warn("... Init done: NO UI mode"):(L.listen(L.get("port")),G.warn("... Init done: Listening on port %s ...",L.get("port"))),D=!0}),w.monitor.on("mqtt",function(a){switch(a){case"active":K&&K.blink(500,5e3);break;case"connected":t.initialized&&(t.synced||t.sync(function(a){a?G.error("gateway sync at mqtt connect FAILURE",a):G.warn("gateway sync at mqtt connect SUCCESS")})),y.publish(y.topic.status,""+["on",(t.reportInterval||6e4)/1e3*1.5]),I&&I.on();break;case"closed":case"error":I&&I.blink()}}),w.monitor.on("sensor",function(a){"active"===a&&J&&J.blink(500,5e3)}),w.monitor.on("actuator",function(a,b,c){var d,e;"command"===a&&(d=b,e=b.options,v.controlActuator(d,e,!0,function(a,b){return a?(G.error("[sensors-controlActuator]",a),c&&c(a)):(G.info("[sensors-controlActuator]",b),c&&c(null,b))}))}),w.monitor.on("time",function(a){"synced"===a&&G.info("time: IN SYNC")}),w.monitor.on("store",function(a,b,c){"tooold"===a&&(G.fatal("[reboot] 1 day old data is not send oldestVal=%j queuedSize=%d",b,c),z.process("reboot",null,function(a,b){a?G.fatal("[reboot] failed err=",a):G.info("[reboot] result=",b)}))}),w.monitor.on("syncConfig",function(){t.sync(function(a){a?G.error("[sysConfig] sync err"):G.info("[sysConfig] done")})}),process.on("uncaughtException",function(a){G.error("[uncaughtException] "+a.stack)}),process.on("exit",function(){I&&I.off(),J&&J.off(),K&&K.off()}),process.on("SIGTERM",function(){G.info("SIGTERM"),process.exit()}),j&&(j.on("stats",function(a){G.debug("[memwatch] stats=",a)}),j.on("leak",function(a){G.error("[memwatch] leak=",a)})),M=i.createSocket("udp4"),N=28282,O="Thing+?",M.bind(N,function(){G.info("discovery BOUND port=[%d]",N)}),M.on("message",function(a,b){if(G.debug("discovery msg",""+a),G.debug("discovery rinfo",b),""+a!==O)return void G.info("discovery ignore unknown request");var c=new Buffer(JSON.stringify({id:B,name:t&&t.name,service:h.Server&&h.Server.service&&h.Server.service.host,mqtt:h.Server&&h.Server.mqtt&&h.Server.mqtt.host,serviceConn:u&&u.status.service.connected?"ok":u&&u.status.service.lastError,mqttConn:u&&u.status.mqtt.connected?"ok":u&&u.status.mqtt.lastError,uptime:""+(g.uptime()/60).toFixed(0)+"m"}));M.send(c,0,c.length,b.port,b.address),G.info("discovery reply myinfo=",""+c)})}),c.register("./etsi.js",function(a,b,c){"use strict";function p(a,b){var d="locationContainer"===Object.keys(a)[0],e=d?a.locationContainer.id:a.container.id;f||(f=c("m2mcore").httpBinder),f.primitiveRequest({targetID:n+"/containers",requestingEntity:n,primitiveType:d?"LOCATION_CONTAINER_CREATE_REQUEST":"CONTAINER_CREATE_REQUEST",rsc:a},function(a,c){return a||"STATUS_CREATED"!==c.statusCode?"STATUS_CONFLICT"===a.statusCode?b(null,n+"/containers/"+e):b(a||Error(c.statusCode)):b(a,c.resourceURI)})}var k,l,m,n,d=c("lodash"),e=c("log4js").getLogger("Main"),f=c("m2mcore").httpBinder,g=c("m2mcore").primitive,h=c("m2mcore").monitor,i=c("./sensors"),j=c("./gateway"),o={};a.exports.init=function(a,b,c){f.init({sclInfo:a},function(a){var b,k;return a?(e.error("httpBinder.init() "+a.stack),c(Error(f.init()))):(b=g.sclInfo,k=b.hSclBase+"/applications/"+b.id,0===b.protocol.indexOf("http")&&l(),d.each(i.sensorsData,function(a,b){m(b,b,j.sensors[b].type,i.sensorsData[b].interval,i.sensorsData[b].firstDelay)}),b=g.sclInfo,k=b.hSclBase+"/applications/"+b.id,e.info("... http initialized."),h.on("registration",function(){l()}),h.on("registration updated",function(){}),h.on("disconnect",function(a){e.error("disconnect url= ",a)}),c&&c())})},k=function(a,b){f.primitiveRequest({targetID:a+"/contentInstances",requestingEntity:n,primitiveType:"CONTENT_INSTANCE_CREATE_REQUEST",rsc:{contentInstance:{contentTypes:{contentType:["application/json"]},content:b}}},function(){})},l=function(){function a(a){var b=o[a];p({container:b.config},function(c,d){return c?void e.error("container creatin failure: ",c):(b.url=d,void e.debug("container:"+a+" url="+d))})}d.forOwn(o,function(b){e.debug("... making container for",b),a(b)})},m=function(a,b,c,d,e){var f=!1,g=null;o[a]={config:{id:b,maxNrOfInstances:100},url:g,available:f,type:c,interval:d,firstDelay:e}}}),c.register("./gateway.js",function(a,b,c){"use strict";var l,m,d=c("log4js").getLogger("Gateway"),e=c("config"),f=c("lodash"),g=c("retry"),h=c("./server"),i=c("./utils"),j=6e4,k=Number(e.Gateway&&e.Gateway.reportInterval,10)||j;k=j>k?j:k,l=i.statusError,m=a.exports={synced:!1,initialized:!1},m.putItem=function(a,b){void 0!==a.reportInterval&&(a.reportInterval=a.reportInterval>j?a.reportInterval:j),h.putGateway(a,b)},m.init=function(a,b){var c=this;this.id=a,this.name=e.Gateway.name,this.sensors=e.Sensors,this.reportInterval=k,this.initialized&&d.error("Gateway init, already initailzied"),i.getBoardInfo(function(a,i){!a&&i&&(c.board=i),d.info("[Gateway.init] board=",i),h._getGateway({embed:"sensors"},function(a,h){var i,k,l;return c.initialized=!0,a?(i=g.operation({retries:30,maxTimeout:72e5}),i.attempt(function(a){return c.synced?void d.warn("gateway.sync SUCCESS, tries:[%d]",a):void m.sync(function(b){return c.synced?void d.warn("gateway.sync SUCCESS, tries:[%d]",a):void(i.retry(b)&&d.error("gateway.sync FAILURE, tries:[%d]",a,b))})}),d.error("Gateway init, NOT IN SYNC, ignoring",a),b&&b()):(k={},void 0!==h.reportInterval&&(l=Number(h.reportInterval,10),l=l>j?l:j,c.reportInterval=l),e.Gateway.name=h.name?h.name:c.name,e.Gateway.reportInterval=c.reportInterval,h.sensors&&f.forEach(h.sensors,function(a){a&&f.isObject(a)&&a.id&&(k[a.id]=a)}),e.Sensors=k,c.sensors=e.Sensors,c.model=h.model,c.deviceModels=h.deviceModels,c.autoCreateDiscoverable=h.autoCreateDiscoverable,c.synced=!0,c.lastSync=Date.now(),d.warn("Gateway.init",JSON.stringify(c,null,2)),b&&b())})})},m.sync=function(a){var b=c("./sensors"),g=this;return this.initialized?void h._getGateway({embed:"sensors"},function(c,h){var i,k,l,n;return c?(404===c.statusCode?(d.error("Gateway not found and remove all sensors"),f.each(e.Sensors,function(a,c){b.removeSensor(c)})):d.error("Gateway init, server sync err=",c),a&&a(c)):(i={},void 0!==h.reportInterval&&(k=Number(h.reportInterval,10),k=k>j?k:j,g.reportInterval=k),e.Gateway.name=h.name?h.name:g.name,e.Gateway.reportInterval=g.reportInterval,h.sensors&&f.forEach(h.sensors,function(a){a&&f.isObject(a)&&a.id&&(i[a.id]=a)}),l=f.difference(f.keys(i),f.keys(m.sensors)),n=f.difference(f.keys(m.sensors),f.keys(i)),f.each(l,function(a){b.newSensor(a,i[a])}),f.each(n,function(a){b.removeSensor(a)}),g.synced=!0,g.lastSync=Date.now(),d.warn("Gateway.sync",JSON.stringify(g,null,2)),a&&a())}):(d.error("Gateway.sync, initialize first"),a&&a(l(400,"not initialized")))}}),c.register("./mqtt.js",function(a,b,c){"use strict";function y(b){x=[p,q,r,b].join("/"),w={base:x,logFilter:x+"/log/filter",log:x+"/log",status:x+"/status",mqttStatus:x+"/mqtt/status",rpcRequest:x+"/req",rpcResponse:x+"/res",getSensor:function(a){return[x,s,a].join("/")},getSensorStatus:function(a){return[x,s,a,"status"].join("/")},getActuator:function(a){return[x,t,a].join("/")}},a.exports.topic=w}var w,x,d=c("log4js").getLogger("MQTT"),e=c("./mqttHelper"),f=c("./remotecontroller"),g=c("zlib"),h=c("lodash"),i=c("util"),j=c("./mqtt_log_appender"),k=c("./utils"),l=c("config"),m=c("async"),n=k.monitor,o=500,p="v",q="a",r="g",s="s",t="a",u=null,v=!1;n.on("store",function(a){return v&&"new"===a?u&&u.publishExt():void 0}),n.on("time",function(a){return"synced"===a?(v=!0,u&&u.publishExt()):void 0}),a.exports.init=function(b,c,k,p,q,r){y(k);var s={clientId:k,keepalive:Number(l.Gateway.reportInterval,10)/1e3*2,clean:!0,autopuback:!1,logger:d,will:{topic:w.mqttStatus,payload:"err",retain:!0}};d.info("[mqtt-init] opts",s),s.store=q,!r&&p&&"function"==typeof p&&(r=p,p=null),l.Server&&l.Server.mqtt&&(s.retryConnectInterval=l.Server.mqtt.retryConnectInterval,s.ackTimeout=l.Server.mqtt.ackTimeout);try{u=p?new e(b,c,i._extend(s,p)):new e(b,c,s)}catch(t){return r&&r(t)}return u?(u.on("connect",function(){try{u.subscribe([w.rpcRequest,w.logFilter],{qos:1},function(a,b){a?d.error("subscribe:"," err=",a):d.info("subscribe:"," granted=",b)})}catch(a){return d.error("mqtt init() fail / exception=",a),u.client.end()}try{u.publish(w.mqttStatus,"on",{qos:1,retain:!0}),n.emit("mqtt","connected"),d.info("mqtt CONNECTED")}catch(a){d.error("mqtt init() fail / exception2=",a)}}),u.on("close",function(){n.emit("mqtt","closed"),d.warn("mqtt close")}),u.on("error",function(a){n.emit("mqtt","error"),d.error("mqtt error",a)}),u.on("message",function(b,c,e,i){var k,l,p;if(d.debug("mqtt messages",b,c,e),b===w.rpcRequest){try{k=JSON.parse(c)}catch(n){}if(!k)return d.error("unknown Rpc message",c),i&&i();k&&k.params&&k.params.aws?(l=k.params.aws,delete k.params.aws,d.info("gatewayRpc:",k),k.params.aws=l):d.info("gatewayRpc:",k),m.series([function(b){if(f.checkRestart(k.method)){var c=setTimeout(function(){return c=null,b()},1e4),e={id:k.id,result:{stdout:"requireResart"}};a.exports.publish(w.rpcResponse,JSON.stringify(e),{qos:1,retain:!1},function(){c?(d.info("[gatewayRpc] requireRestart sent"),clearTimeout(c),b()):d.error("[gatewayRpc] restart puback took 10secs")})}else b()},function(a){f.process(k.method,k.params,function(b,c){var e,f;b?(d.error("remocon.process:",b),h.isObject(b)?b instanceof Error?b={code:-32e3,message:b&&""+b||"unknown error"}:b.code&&b.message||(b={code:b.code||-32e3,message:b.message||b&&""+b||"unknown error"}):b={code:-32e3,message:b&&""+b||"unknown error"},e={id:k.id,error:b}):(d.info("remocon.process done",k),e={id:k.id,result:c||""}),f=JSON.stringify(e),f.length>o?g.gzip(f,function(c,d){var e={code:-32e3,message:"zip error"};u.publish(w.rpcResponse,c?JSON.stringify(e):d,{qos:1,retain:!1}),a(b)}):(u.publish(w.rpcResponse,f,{qos:1,retain:!1}),a(b))})}],function(){return i&&i()})}else{if(b!==b.logFilter)return d.error("remocon unknown topic",b),i&&i();try{p=JSON.parse(c)}catch(n){"string"==typeof c&&(p=c)}p&&j.setLevelFilter(p)}}),r&&r()):r&&r(Error("mqtt.init failure"))},a.exports.publish=function(a,b,c,e){return d.info("sent(direct) [%s] : %s",a,b),"function"==typeof c&&(e=c,c=void 0),u&&u.publish(a,b,c||{qos:1,retain:!1},e)},a.exports.getStatus=function(){var a=u&&u.getStatus();return a},a.exports.log=function(a){u&&x&&u.publish(w.log,JSON.stringify(a),{qos:1,retain:!1})}}),c.register("./mqttHelper.js",function(a,b,c){"use strict";function s(a,b,c){if(!a||!b)throw Error("port and host are required");c||(c={}),this.port=a,this.host=b,this.opts=c,this.secure=c&&c.caPath?!0:!1,this.client=null,this.ackTimer=null,this.store=c.store,this.status={connected:!1,lastSentTime:null},this.limiter=new j(r,"minute",!0),c.reconnectPeriod=0,c.retryConnectInterval=c.retryConnectInterval||l,c.ackTimeout=c.ackTimeout||m;var f=this;!function g(){var a;d.debug("MH.init()"),f.reinitTimer=null,f.client||(f.status.connected=!1,f.client=a=!0===f.secure?e.createSecureClient(f.port,f.host,f.opts):e.createClient(f.port,f.host,f.opts),d.info("MH CREATE secure("+(f.secure?"yes":"no")+") "+f.host+":"+f.port),f.ackTimer=setTimeout(function(){f.status.connected=!1,d.warn("[mqtt.init] MH.ackTimer out : try disconnect"),f.ackTimer=null,f.client&&(f.client.destroy(),f.client=null)},f.opts.ackTimeout),a.on("message",f.emit.bind(f,"message")),a.on("connect",function(){f.ackTimer&&(clearTimeout(f.ackTimer),f.ackTimer=null),f.emit("connect"),f.status.connected=!0,setTimeout(f.publishExt.bind(f),p)}),a.on("close",function(){return f.status.connected=!1,f.client&&(f.client.destroy(),f.client=null),f.ackTimer&&(clearTimeout(f.ackTimer),f.ackTimer=null),f.reinitTimer?void f.emit("close"):(f.reinitTimer=setTimeout(g.bind(f),f.opts.retryConnectInterval),void f.emit("close"))}),a.on("error",function(){return f.status.connected=!1,f.client&&(f.client.destroy(),f.client=null),f.ackTimer&&(clearTimeout(f.ackTimer),f.ackTimer=null),f.reinitTimer?void f.emit("error"):(f.reinitTimer=setTimeout(g.bind(f),f.opts.retryConnectInterval),void f.emit("error"))}))}()}var d=c("log4js").getLogger("MQTT"),e=c("mqtt"),f=c("events"),g=c("util"),h=c("zlib"),i=c("lodash"),j=c("limiter").RateLimiter,k={qos:1,retain:!1},l=6e4,m=3e4,n=100,o=5e3,p=1e4,q=100,r=120;g.inherits(s,f.EventEmitter),s.prototype.publishExt=function(){var b,c,e,f,g,a=this;if(this.client&&this.status.connected&&0!==this.store.size()&&!this.ackTimer&&(this.store.getFirst(function(c,d){b=a.store.encode(d),b&&(b.seq=c)}),b))return b.message&&this.store.size()>1&&(c={message:{},seq:[],topic:b.topic},e=0,f=b,this.store.forEach(function(g,h){if(b=a.store.encode(h),b.topic!==c.topic)return d.error("bulk topic mismatch",e,c.topic,b.topic),c=f,!1;if(b&&(b.seq=g),b.message)try{b.message=JSON.parse(b.message),i.merge(c.message,b.message,function(a,b){return i.isArray(a)?a.concat(b):void 0}),c.seq.push(b.seq)}catch(j){return d.error("bulk topic JSON format error",e,b.message),c=f,!1}return e++,e>=q?!1:void 0}),b=c,i.isString(b.message)||(b.message=JSON.stringify(b.message))),this.ackTimer=setTimeout(function(){a.status.connected=!1,d.warn("MH.ackTimer out : try disconnect"),a.ackTimer=null,a.client&&(a.client.destroy(),a.client=null)},this.opts.ackTimeout),d.info("MH SENDING ("+(i.isArray(b.seq)?i.first(b.seq)+" ... "+i.last(b.seq):b.seq)+") sz: "+b.message.length+" "+b.topic+" : "+(b.message.length>100?b.message.substr(0,100)+" ...":b.message)),g=function(c){return c?void d.error("MH.publish/callback error",c):(a.status.lastSentTime=Date.now(),a.status.connected=!0,a.ackTimer&&(clearTimeout(a.ackTimer),a.ackTimer=null),d.info("MH SENT ("+(i.isArray(b.seq)?i.first(b.seq)+" ... "+i.last(b.seq):b.seq)+") "+(b.gzipMessage?"zip sz: "+b.gzipMessage.length:"sz: "+b.message.length)+" "+b.topic+" : "+(b.message.length>100?b.message.substr(0,100)+" ...":b.message)),void(i.isArray(b.seq)?(i.each(b.seq,function(b){a.store.rm(b)}),setTimeout(a.publishExt.bind(a),o)):(a.store.rm(b.seq),a.limiter.removeTokens(1,function(b,c){return 0>c?(setTimeout(a.publishExt.bind(a),o),void d.error("Limiting num=",r,"suspend time=",o)):void process.nextTick(a.publishExt.bind(a))}))))},b.message&&b.message.length>n?void h.gzip(b.message,function(c,e){c?d.error("gzip error",b.message.length):b.gzipMessage=e,a.client.publish(b.topic,c?b.message:e,k,g)}):void a.client.publish(b.topic,b.message,k,g)},s.prototype.publish=function(){this.client?this.client.publish.apply(this.client,arguments):d.error("MH.publish fail")},s.prototype.subscribe=function(){this.client?this.client.subscribe.apply(this.client,arguments):d.error("MH.subscribe fail")},s.prototype.getStatus=function(){return this.status},a.exports=s}),c.register("./mqtt_log_appender.js",function(a,b,c){"use strict";function j(a){a&&("string"==typeof a?i=f.toLevel(a,i):(i={},g.each(a,function(a,b){i[b]=f.toLevel(a)})))}function k(a){return a&&j(a),function(a){var b=a.categoryName;a.level.isGreaterThanOrEqualTo(i[b]||i)&&h.log({l:a.level.levelStr.charAt(0),c:b,t:Date.parse(a.startTime),d:e.messagePassThroughLayout(a)})}}function l(a){var b=a&&a.level;return k(b)}var d=c("log4js"),e=d.layouts,f=d.levels,g=c("lodash"),h=c("./mqtt"),i=f.FATAL;b.appender=k,b.configure=l,b.setLevelFilter=j}),c.register("./remotecontroller.js",function(a,b,c){"use strict";function x(a,b){n(a,{encoding:"utf8",timeout:12e4,maxBuffer:512e3,killSignal:"SIGKILL",cwd:__dirname,env:null},function(c,d,e){var f;return c&&(f={code:-32e3,message:c&&""+c||"unknown error"},m.error(a,f)),e&&m.error(a,e),b&&b(f,{stdout:d,stderr:e||void 0})})}function y(a,b){return k.DM[a]&&k.DM[a].support&&k.DM[a].shellCmd?x(k.DM[a].shellCmd,b):(m.error("execCmdFromConfig",a,"Not supported"),b&&b(Error(a+": Not supported")))}var z,A,d=c("os"),e=c("async"),f=c("lodash"),g=c("fs"),h=c("zlib"),i=c("path"),j=c("crontab"),k=c("config"),l=c("ini"),m=c("log4js").getLogger("Main"),n=c("child_process").exec,o=c("./utils"),p=c("rsync"),q=o.monitor,r="/etc/wvdial.conf",s="Dialer Defaults",t={Username:"",Password:"",Enable:!1,"Stupid mode":"yes"},u="/etc/network/interfaces.d/wlan.cfg",v=1048576,w={};f.each(["wvdial","wvdialconf"],function(a){n("which "+a,function(b){w[a]=!b})}),z={controlActuator:function(a,b,c){q.emit("actuator","command",b,c)},timeSync:function(a,b,c){var d,e;return b&&b.time&&f.isNumber(b.time)&&o.isValidTime(b.time)?(e=b.time/1e3,o.isValidTime()?(m.info("time sync already"),c&&c()):(m.warn("time sync @"+e),void x("date -s @"+e+"; service ntp restart",c))):(d={code:-32e3,message:"invalid time"},m.error("invalid timesync req"),c&&c(d))},poweroff:function(a,b,c){return y("poweroff"),c&&c()},reboot:function(a,b,c){return y("reboot"),c&&c()},resetConfig:function(a,b,c){var d=process.env.NODE_CONFIG_DIR?process.env.NODE_CONFIG_DIR:i.join(__dirname,"config");x("rm -f "+i.join(d,"runtime.json"),function(){return x("sh ./update/restart.sh &"),c&&c()})},syncConfig:function(a,b,c){return q.emit("syncConfig"),c&&c()},rebootEveryday:function(a,b,c){j.load(function(a,d){var e,g,h,i,j;return a?(e={code:-32e3,message:""+a},c&&c(e)):(g=b&&b.cmd,h=b&&parseInt(b.hourAt,10),i=b&&parseInt(b.minAt,10),g?(d.remove(d.findCommand(g)),f.isNumber(h)?(j=d.create(g),j.hour().on(h),j.minute().on(i||0),void d.save(function(a){return a?(e={code:-32e3,message:"cron save error="+a},c&&c(e)):c&&c()})):c&&c()):(e={code:-32e3,message:"invalid params="+JSON.stringify(b)},c&&c(e)))})},restart:function(a,b,c){return y("restart"),c&&c()},swUpdate:function(a,b,c){if(!(k.DM&&k.DM.swUpdate&&k.DM.swUpdate.internal))return y("swUpdate"),c&&c();var d=p.build({flags:"avz",source:"rsync://"+k.Sync.id+"@"+k.Sync.host+":8873/"+k.Sync.id,destination:".."});m.info("source: ",d.args()),process.env.RSYNC_PASSWORD=k.Sync.password,d.set("delete-after"),d.set("delete-excluded"),d.set("f","P /device/config/runtime.json"),d.execute(function(a,b,d){var e,f,h,i;return 0!==b?(m.error("rsync error",a,b,d),c&&c(Error(d+": "+a))):(m.info("swUpdate Done"),e=g.readFileSync("../VERSION",{encoding:"utf8"}),f=e.split("\n"),m.info("swInfo: local = ",f),result.local.version=f[0],result.local.date=f[1],result.local.comment=f[2],h=g.readFileSync("../REMOTE_VERSION",{encoding:"utf8"}),i=h.split("\n"),m.info("swInfo: remote = ",i),result.remote.version=i[0],result.remote.date=i[1],result.remote.comment=i[2],c(null,result))})},log:function(a,b,c){var f,j,d=b&&b.fileNum&&parseInt(b.fileNum),e=i.join(k.Gateway.logBaseDir,k.Gateway.logName);try{if(d&&(e=e+"."+d),!g.existsSync(e)&&(e+=".gz",!g.existsSync(e)))return c&&c(Error("none exist log:"+e));if(j=g.statSync(e),!j||j.size>v)return m.error("too big log:",e),c&&c(Error("too big log:"+e));if(f=g.readFileSync(e),!f)return m.error("error to read log:",e),c&&c(Error("error to read log:"+e));if(8075===f.readUInt16BE(0))return m.info("zip log:",e),c&&c(null,f);h.gzip(f,function(a,b){return a?(m.error("zip log:",a),c&&c(Error("zip log:"+e))):(m.info("zip log:",e),c&&c(null,b))})}catch(l){return m.error("failure to get log:",e),c&&c(l)}},modem:function(a,b,c){var h,i,j,d={};return!b||!b.cmd||"getModemConfig"!==b.cmd&&"setModemConfig"!==b.cmd?(h={code:-32e3,message:"invalid params="+b},c&&c(h)):"setModemConfig"!==b.cmd||b.config&&b.modem?w.wvdial?(j=!1,void e.series([function(a){n("/etc/init.d/wvdial.sh status",function(b){return b||(j=!0),a()})},function(a){return"getModemConfig"!==b.cmd&&j?void n("/etc/init.d/wvdial.sh stop",function(){return j=!1,a()}):a()},function(a){if(j)return a();var c="getModemConfig"===b.cmd?"/dev/null":r;n("wvdialconf "+c,function(b){return b?a("MODEM, not found"):a()})},function(a){try{i=l.parse(g.readFileSync(r,"utf-8"))}catch(b){m.error("wvdialConf parse",b)}return i&&i[s]?a():a(Error("wvdial conf not found"))}],function(a){if(a)return m.error(b.cmd,"err",a),h={code:-32e3,message:""+a},c&&c(h);var e=i[s];return"setModemConfig"===b.cmd&&(k.Modem=b.config,e.Phone="*99#",(f.isUndefined(e.Baud)||f.isNaN(+e.Baud)||+e.Baud<115200)&&(e.Baud=115200),f.defaults(e,t),e.Username=b.config.APN_USER,e.Password=b.config.APN_PASS,e.Init3='AT+CGDCONT=1, "IP", "'+b.config.APN+'"',e.Enable=!!b.config.ENABLED,g.writeFileSync(r,l.stringify(i)),e.Enable?n("/etc/init.d/wvdial.sh restart",function(a,b,c){m.info("wvdial restart",a,b,c)}):n("/etc/init.d/wvdial.sh stop",function(a,b,c){m.info("wvdial stop",a,b,c)}),m.info("setModemConfig",e)),d.config=k.Modem,d.modem=e.Modem,d.modemType=e["Modem Type"],c&&c(null,[d])})):(h={code:-32e3,message:"modem scanner is not available"},c&&c(h)):(h={code:-32e3,message:"setModemConfig requires params.config and modemId"},c&&c(h))},netInfo:function(a,b,c){var h,l,o,g=["lo","usb"],i=b&&b.ifName,j=[],k=[],m=d.networkInterfaces();return f.isEmpty(m)||i&&!m[i]?(h={code:-32e3,message:"not found ???"},c&&c(h)):(i&&(o=m[i],m={},m[i]=o),f.each(m,function(a,b){var c=f.where(a,{family:"IPv4"});f.any(g,function(a){return 0===b.indexOf(a)})||f.isEmpty(c)||(j.push(b),k.push(c[0]))}),l=f.zipObject(j,k),void e.eachSeries(j,function(a,b){n("ifconfig "+a,function(c,d){if(d){var e=d.match(/RX\ bytes:(\d+).*TX\ bytes:(\d+)/);e?(l[a].RxBytes=e[1],l[a].TxBytes=e[2]):(l[a].RxBytes="Unknown",l[a].TxBytes="Unknown")}b()})},function(){var a=[];return f.each(l,function(b,c){a.push(f.extend({id:c},b))}),f.isEmpty(a)?(h={code:-32e3,message:"not found"},c&&c(h)):i?c&&c(null,a[0]):c&&c(null,a)}))},swInfo:function(a,b,c){var h,d={local:{},remote:{}},e="swInfo";return k.DM[e]&&k.DM[e].support&&(k.DM[e].shellCmd||k.DM[e].internal)?void(k.DM[e].internal?(h=p.build({flags:"z",source:"rsync://"+k.Sync.id+"@"+k.Sync.host+":8873/"+k.Sync.id+"/VERSION",destination:"../REMOTE_VERSION"}),m.info("source: ",h.args()),process.env.RSYNC_PASSWORD=k.Sync.password,h.execute(function(a,b,e){var f,h,i,j;return 0!==b?(m.error("rsync error",a,b,e),c&&c(Error(e+": "+a))):(m.info("getSwInfo Done"),f=g.readFileSync("../VERSION",{encoding:"utf8"}),h=f.split("\n"),m.info("swInfo: local = ",h),d.local.version=h[0],d.local.date=h[1],d.local.comment=h[2],i=g.readFileSync("../REMOTE_VERSION",{encoding:"utf8"}),j=i.split("\n"),m.info("swInfo: remote = ",j),d.remote.version=j[0],d.remote.date=j[1],d.remote.comment=j[2],c(null,d))})):n(k.DM[e].shellCmd,function(a,b,e){var h,i,g={};return h=b&&b.split("\n"),m.debug(b,h),f.each(h,function(a){var b=/^@@(\w+)/.exec(a);b?(i=b[1],g[i]={lines:[]}):g[i].lines.push(a)}),f.isEmpty(g)?m.error("cmd=swInfo","err=",a,"stdout=",b,"stderr=",e):f.each(d,function(a,b){g[b]&&g[b].lines&&(d[b]={version:g[b].lines[0],date:g[b].lines[1],comment:g[b].lines[2]})}),c&&"function"==typeof c?c(null,d):void 0})):(m.error("execCmdFromConfig",e,"Not supported"),c&&c(Error(e+": Not supported")))},setProperty:function(a,b,c){var d,f,h,i;m.info("[RMCTRL] setProperty",b),e.series([function(a){return b.wlan&&(d=g.readFileSync(u,"utf8"),d?(f=d.replace(/^\s*wpa-ssid\s+"(.*)"/gim,' wpa-ssid "'+b.wlan.ssid+'"').replace(/^\s*wpa-psk\s+"(.*)"/gim,' wpa-psk "'+b.wlan.psk+'"'),d!==f&&g.writeFileSync(u,f)):m.error("NO wlan config found"),h=!0),b.reportInterval&&(i=!0),a()},function(a){b.modem?z.modem("modem",{cmd:"setModemConfig",config:{APN:b.modem.APN,APN_USER:b.modem.APN_USER,APN_PASS:b.modem.APN_PASS,ENABLED:b.modem.ENABLED}},function(b){return h=!0,a(b)}):a()}],function(a){return a&&m.error("failure to setModemConfig",a),h?z.reboot():i&&z.restart(),c&&c()})}},A={controlActuator:{proc:z.controlActuator,restart:!1},setProperty:{proc:z.setProperty,restart:!0},timeSync:{proc:z.timeSync,restart:!1},poweroff:{proc:z.poweroff,restart:!0},reboot:{proc:z.reboot,restart:!0},resetConfig:{proc:z.resetConfig,restart:!0},rebootEveryday:{proc:z.rebootEveryday,restart:!1},restart:{proc:z.restart,restart:!0},swUpdate:{proc:z.swUpdate,restart:!0},log:{proc:z.log,restart:!1},modem:{proc:z.modem,restart:!1},netInfo:{proc:z.netInfo,restart:!1},swInfo:{proc:z.swInfo,restart:!1},syncConfig:{proc:z.syncConfig,restart:!1}},a.exports.process=function(a,b,c){var e,d=a&&A[a]&&A[a].proc;return d?void d(a,b,c):(m.info("[RMCTRL] unknown method:",a,A[a]),e={code:-32e3,message:"unknown command:"+a},c&&c(e))},a.exports.checkRestart=function(a){return A[a]&&A[a].restart?!0:!1}}),c.register("./routes.js",function(a,b,c){"use strict";var d=c("log4js").getLogger("Main"),e=c("lodash"),f=c("config"),g=c("fs"),h=c("./gateway"),i=c("./remotecontroller"),j=c("./server"),k=c("./sensors");a.exports.gatewayInfo=function(){return function(a,b){h.sync(function(){b.send(JSON.stringify(h))})}},a.exports.gatewayConfig=function(){return function(a,b){var c=a.body;h.putItem(c,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})}},a.exports.gatewayControl=function(){return function(a,b){var c=a.query.command,f=["poweroff","reboot","restart","swUpdate","resetConfig"];return c&&e.contains(f,c)?(d.info("[HTTPAPI] gatwayControl",c),void i.process(c,null,function(a,e){d.info("[HTTPAPI] gatwayControl",c,a||e),a?b.send(404,"command failure"+a):b.send(e)})):b.send(400,"bad request: invalid param")}},a.exports.serverInfo=function(){return function(a,b){j.statusUpdate(function(){var a=["config","status","registered"],c={};e.each(a,function(a){c[a]=j[a]}),d.info("[HTTPAPI] /api/server/info",JSON.stringify(c,null,2)),b.send(c)})}},a.exports.softwareInfo=function(){return function(a,b){i.process("swInfo",null,function(a,c){d.info("[HTTPAPI] /api/software/info",a||c),a?b.send(404,"not found"):b.send(c)})}},a.exports.sensorData=function(){return function(a,b){d.info("[HTTPAPI] /api/sensor/data",JSON.stringify(k.sensorsData)),b.send(JSON.stringify(k.sensorsData))}},a.exports.sensorDiscover=function(){return function(a,b){var c=a.query.driverName;k.discover(c,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})}},a.exports.getSensorItem=function(){return function(a,b){var d,c=a.params.id;return c?(d={driverName:a.query.driverName,model:a.query.model,network:a.query.network,address:a.query.address},void k.getItem(c,d,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})):b.send(400,"empty sensorId")}},a.exports.delSensorItem=function(){return function(a,b){var c=a.params.id;return c?void k.delItem(c,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)}):b.send(400,"empty sensorId")}},a.exports.postSensorItem=function(){return function(a,b){var d,c=a.body.id;return c?(d=a.body,d.reqId=c,delete d.id,d.series="sensor"===a.body.category?c:null,d.owner=h.id,d.ctime=Date.now(),void k.postItem(d,function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})):b.send(400,"empty sensorId")}},a.exports.certUpload=function(){return function(a,b){var c=a.files.cert;b.setHeader("Content-Type","text/html"),j.postCert(c,function(a,c){b.send(a?{statusCode:a.statusCode,msg:""+a}:{statusCode:200,msg:c})})}},a.exports.apikeyUpload=function(){return function(a,b){var c=a.body.apikey;j.postAPIKey(c,function(a,c){b.send(a?{statusCode:a.statusCode,msg:""+a}:{statusCode:200,msg:c})})}},a.exports.getApikey=function(){return function(a,b){b.send(j.getAPIKey())}},a.exports.getInterfaces=function(){return function(a,b){i.process("netInfo",null,function(a,c){d.info("[HTTPAPI] getInterfaces netInfo",a||c),a?b.send(404,"not found"):b.send(c)})}},a.exports.getInterfaceItem=function(){return function(a,b){var c=a.params.id;return c?void i.process("netInfo",{ifName:c},function(a,e){d.info("[HTTPAPI] getInterface netInfo",c,a||e),a?b.send(404,"not found"):b.send(e)
}):b.send(400,"empty id")}},a.exports.getModems=function(){return function(a,b){i.process("modem",{cmd:"getModemConfig"},function(a,c){d.info("[HTTPAPI] getInterface modem, getModemConfig",a&&a.message||c),a?b.send(404,"not found"):b.send(c)})}},a.exports.getModemItem=function(){return function(a,b){var c=a.params.id&&decodeURIComponent(a.params.id);i.process("modem",{cmd:"getModemConfig",modem:c},function(a,e){d.info("[HTTPAPI] getInterface modem, getModemConfig",c,a||e),a||!e||0===e.length?b.send(404,"not found"):b.send(e[0])})}},a.exports.putModemItem=function(){return function(a,b){var c=a.params.id&&decodeURIComponent(a.params.id),e=a.body;i.process("modem",{cmd:"setModemConfig",modem:c,config:e},function(a,e){d.info("[HTTPAPI] getInterface modem, setModemConfig",c,a||e),a||!e||0===e.length?b.send(400,"err="+a):b.send(e[0])})}},a.exports.chPasswd=function(){return function(a,b){var c=a.body.currentPassword,d=a.body.newPassword;c&&d&&f.Auth.admin===c?(f.Auth.admin=d,b.end()):b.send(400,"password mismatch or missing new password")}},a.exports.getModemStats=function(){return function(a,b){var c="/run/umtskeeper/umtskeeper.stat";g.readFile(c,function(a,c){var e,f={},g={};a&&d.error("[ModemStats]",a),e=["rxBDays","rxBDaysLastMonth","rxBHrs","rxBHrsAcc","rxBHrsYesday","rxBMonth","rxBQHrs","rxBQHrsAcc","rxBQHrsYesday","rxBToday","rxBTot","rxBYesday","txBDays","txBDaysLastMonth","txBHrs","txBHrsAcc","txBHrsYesday","txBMonth","txBQHrs","txBQHrsAcc","txBQHrsYesday","txBToday","txBTot","txBYesday"],e.forEach(function(a){var b=RegExp(a+"':\\s(.*),\\s\\\\");f[a]=(""+c).match(b)[1]}),d.info("[ModemStats] Stats",f),g.stats=f,g.gateway=h,a||!f?b.send(404,"not found"):b.send(g)})}},a.exports.controlActuator=function(){return function(a,b){var c,d;c=a.body,d=a.body.options,k.controlActuator(c,d,!1,function(a,c){a?(b.writeHead(a.statusCode||400),b.end(a&&""+a)):b.send(c)})}},a.exports.getSensorDrivers=function(){return function(a,b){j.getSensorDrivers(function(a,c){a?(b.writeHead(a.statusCode),b.end(""+a)):b.send(c)})}}}),c.register("./sensors.js",function(a,b,c){"use strict";function I(a,b){return a&&a.replace(/\{(\w+)\}/g,function(a,c){return b[c]})}function J(a){var b,c,f,h,i,j,k,m,n,q,w;if(!(a&&a.id&&o.sensors&&o.sensors[a.id]))return void d.warn("invalid sensor data or, sensor  no longer exit",a);if(b=o.reportInterval/1e3*1.5,c=a.status,f=a.id,h=o.sensors[f].type,i=a.result?a.result[h]:null,j=a.time&&a.time[h]?a.time[h]:l.now(),v.emit("sensor","active"),n=H.sensorsData[f].status,"off"===c)H.sensorsData[f].status=C,d.warn("OFF from driver","index=",H.sensorsData[f],"id=",f);else if("error"===c||"err"===c)H.sensorsData[f].status=D,d.warn("Can not get data from sensor",a.message,"index=",H.sensorsData[f],"id=",f);else{if("ok"!==c&&"on"!==c)return void d.error("Unexpected result code",c,"id=",f);d.debug(f+" => "+i),null===i||void 0===i?(H.sensorsData[f].status=B,d.debug("sensorDataHandler: no value, status(ok) only","id=",f)):(q={v:i,u:parseInt(1e3*g.uptime(),10)},s.isValidTime(j)&&(q.t=j),H.sensorsData[f].latest=q,H.sensorsData[f].values.push(q),H.sensorsData[f].status=B,H.sensorsData[f].type=h,r.getSensorProperties(e.Sensors[f].model).onChange&&(w={},w[f]=H.sensorsData[f].values,u.push({topic:t.topic.base,message:w}),H.sensorsData[f].values=[]))}m=H.sensorsData[f].status,n!==m&&(k=m===B?b:-1,d.info("[%s] sensor status: %s -> %s",f,n,m),p.isConnected("mqtt")?t.publish(t.topic.getSensorStatus(f),""+[m,k]):d.warn("sensor status: NOT SENT due to mqtt unavailable"))}function K(a){d.debug("sensorChangeHandler() currentData=",a),J(a)}function L(a,b){var c,e,f,g,h,i,j;return b&&b.model&&(e=r.getSensorProperties(b.model)),e?(g="sensorjs",h=b.network||e.supportedNetworks[0],i=e.addressable?b.address:b.address||a,j=b.model,f=g+"://"+["",h,i,j,a].join("/"),b.options&&(f+="?"+m.stringify(b.options)),c=r.createSensor(f),d.info("sensorUrl",f),c):(d.error("sensor properties are necessary",b),null)}var w,x,z,A,B,C,D,E,F,G,H,d=c("log4js").getLogger("Sensors"),e=c("config"),f=c("util"),g=c("os"),i=(c("url"),c("shorthash")),j=c("path"),k=c("fs"),l=c("lodash"),m=c("querystring"),n=c("async"),o=c("./gateway"),p=c("./server"),q=c("sensorjs"),r=q.sensor,s=c("./utils"),t=c("./mqtt"),u=c("./store"),v=s.monitor;w=k.existsSync(j.join(__dirname,"node_modules"))?l.filter(k.readdirSync(j.join(__dirname,"node_modules")),function(a){return-1!==a.indexOf("sensorjs-")}):["sensorjs-foscam","sensorjs-jsonrpc"],l.each(w,function(a){try{r.addSensorPackage(c(a))}catch(b){d.warn("MODULES_NOT_SUPPORTED - "+a)}});try{x=c("aws-sdk")}catch(y){d.warn("MODULES_NOT_SUPPORTED - aws-sdk")}z=5e3,A=Number(e.Gateway&&e.Gateway.firstDelay,10)||z,B="on",C="off",D="err",E=6e4,F=s.statusError,G=!1,H=a.exports={sensors:{},sensorsData:{}},v.on("mqtt",function(a){G&&"connected"===a&&H.mqttPublishAll()}),H._newSensor=function(a,b){var c,e,f;H.sensors[a]&&(d.warn("remove before adding sensor",a),H._removeSensor(a)),c={model:b.model,macAddress:o.id},b&&b.model&&(e=r.getSensorProperties(b.model)),f=L(a,b),"actuator"===b.category?H.sensors[a]=f:e&&f?(H.sensorsData[a]={values:[],latest:null,_time:null,firstDelay:A,status:null,interval:e.recommendedInterval||E},d.info("newSensor:",a,c),e.onChange?(f.on("change",K),f.listen("change")):(f.on("data",J),f.listen(c.retriveInterval)),H.sensors[a]=f):d.error("newSensor failure / driverName=",b.driverName,"sensorId=",a,"options=",c)},H.newSensor=function(a,b){e.Sensors[a]=b,e.Sensors=f._extend({},e.Sensors),o.sensors=e.Sensors,H._newSensor(a,b)},H.updateSensor=function(a,b){e.Sensors[a]=b,e.Sensors=f._extend({},e.Sensors),o.sensors=e.Sensors},H._removeSensor=function(a){var b=H.sensors[a];b&&(b.clear&&(b.clear(),d.info("sensor is cleared",a)),b.removeListener("data",J),b.removeListener("change",K),delete H.sensors[a],l.has(H.sensorsData,a)&&delete H.sensorsData[a])},H.removeSensor=function(a){d.info("removeSensor:",a),e.Sensors[a]&&(delete e.Sensors[a],e.Sensors=f._extend({},e.Sensors),o.sensors=e.Sensors),H._removeSensor(a)},H.discover=function(a,b){var c,e=[],f=[],g=r.getSensorProperties(a);return g&&g.discoverable?void r.discover(a,function(a,g){return d.info("discovered devices info",g),a?void d.error("err=",a.stack):g.length>0?(l.each(g,function(a){l.each(a.sensorUrls,function(a){e.push(r.parseSensorUrl(a))})}),l.each(o.sensors,function(a,b){for(var c=e.length-1;c>=0;c--)e[c].id===b&&(e.splice(c,1),f.push(b))}),d.info("[HTTPAPI] /api/discover - founds",e),c={"new":e,registered:f},b&&b(null,c)):b&&b(F(404,"not found"))}):b&&b(F(404,"not discoverable"))},H.getItem=function(a,b,c){var g,h,i,e=b.model,f={model:e,macAddress:o.id};return a&&e?(d.info("[HTTPAPI] GET /api/sensors/:id sensorId=",a,"model=",e,"options=",f),b&&b.model&&(g=r.getSensorProperties(b.model)),(h=L(a,b))?(i=setTimeout(function(){return d.info("[HTTPAPI] GET /api/sensors/:id, timeout",1.5*g.recommendedInterval),h&&h.clear&&h.clear(),h=null,c&&c(F(404,"not found"))},1.5*g.recommendedInterval),h.once("data",function(a){return clearTimeout(i),h?(d.info("[HTTPAPI] GET /api/sensors/:id, sent response and sensor is deleted",h.id),h.clear&&h.clear(),h=null,c&&c(null,a)):void 0}),void h.listen(0)):(d.warn("createSensor() failure / model=",e,"sensorId=",a,"options=",f),c&&c(F(404,"not found in local sensor list")))):c&&c(F(400,"Sensor ID and model are required"))},H.delItem=function(a,b){p.delSensor(a,function(c){return c?b&&b(F(400,"failure to delete sensor="+a)):(H.removeSensor(a),b&&b(null,JSON.stringify(o)))})},H.postItem=function(a,b){var c=a.reqId;return d.info("postItem - sensorId",c),p.isConnected()?void p.upsertSensor(c,a,function(a,e){return a?b&&b(a):(o.sensors[c]?(d.warn("postItem: already exist",c,o.sensors[c]),H.updateSensor(c,e),d.info("postItem - sensor info is updated")):(H.newSensor(c,e),d.info("postItem - new sensor is added",c,e)),b&&b(null,JSON.stringify(o.sensors)))}):b&&b(F(403,"registration is required or not connected"))},H.controlActuator=function(a,b,c,e){var h,f=a.id,g=a.aws;if(delete a.aws,l.has(H.sensors,f))h=H.sensors[f],d.info("[sensors] actuator is existing",f);else{if(!a.id||!a.model)return e&&e(F(400,"Sensor ID and model are required"));if(d.info("[HTTPAPI] POST /api/actuator/control sensorInfo=",a),h=L(f,a),setTimeout(function(){h.clear(),h=null},5e3),!h)return d.warn("controlActuator() failure/ sensorInfo=",a),e&&e(F(404,"not found in local sensor list"))}h.set(a.cmd,b,function(a,b){var f,h,i,j={};return a||!b||!l.isObject(b)&&!l.isString(b)?(i="invalid result type",c&&(j.code=-32e3,j.message=a&&a.message||i,i=j),d.debug("[Sensors.controlActuator] / error",i),e&&e(i,b)):(d.info("[sensors/controlActuator] return result",b),x&&g&&g.config&&g.upload?(d.info("[sensors/controlActuator] upload"),h=g.upload,x.config.update(g.config),f=new x.S3,h.Body=b.content,h.ContentType=b.contentType,void f.putObject(h,function(a){return a?(i=""+a,c&&(j.code=-32e3,j.message=i,i=j),d.error("[sensors/controlActuator] upload err",i)):(d.info("[sensors/controlActuator] Successfully uploaded"),b._uploaded=!0,delete b.content),e&&e(i,b)})):(d.info("controlActuator() no upload Info"),e&&e(i,b)))})},H.mqttPublishAll=function(){var b,e,a=(o.reportInterval||6e4)/1e3*1.5,c={};p.isConnected("mqtt")&&v.emit("mqtt","active"),b=!p.timeSynced||u.fsFull||u.memFull?{status:D,duration:-1,sensors:[]}:{status:B,duration:a,sensors:[]},l.each(H.sensorsData,function(d,e){var f=d.status;f===B&&d.values.length>0&&(c[e]=d.values,d.values=[]),b.sensors.push({id:e,status:f||C,duration:f===B?a:-1})}),l.isEmpty(c)||u.push({topic:t.topic.base,message:c}),l.each(l.where(o.sensors,{category:"actuator"}),function(c){var e,d=c.id;if(!b.sensors[d]){try{e=H.sensors&&H.sensors[d]&&H.sensors[d].getStatus()}catch(f){}b.sensors.push({id:d,status:e||C,duration:e===B?a:-1})}}),d.info("[%s] status",o.id,b),e=[b.status,b.duration],e=e.concat(l.zip(l.pluck(b.sensors,"id"),l.pluck(b.sensors,"status"),l.pluck(b.sensors,"duration"))),p.isConnected("mqtt")?t.publish(t.topic.status,""+e):d.warn("Gateway status: NOT SENT due to unavailable mqtt")},H.init=function(a){return G?a&&a():(G=!0,l.each(o.sensors,function(a,b){H._newSensor(b,a)}),o.model&&o.deviceModels&&n.waterfall([function(a){p.getSensorDrivers(function(b,c){return b?a(b):a(null,c)})},function(a,b){p.getGatewayModel(o.model,function(c,d){return c?b(c):b(null,a,d)})},function(a,b,c){var e=l.pluck(o.sensors,"id");if(!o.deviceModels)return c();if("n"===o.autoCreateDiscoverable)return d.info("[sensors/init] skip discovering devices and sensors - autoCreateDiscoverable Off",o.autoCreateDiscoverable),c();if("string"==typeof o.deviceModels){d.info("[sensors/init] string type",o.deviceModels);try{o.deviceModels=JSON.parse(o.deviceModels)}catch(f){return d.info("[sensors/init] JSON parse error",o.deviceModels),c()}}n.eachSeries(o.deviceModels,function(c,f){var g=l.find(b&&b.deviceModels,{id:c.model});return g&&g.sensors?void n.eachSeries(g.sensors,function(b,f){var h=l.find(a,{id:b.driverName});return h.discoverable&&"true"===h.discoverable?void H.discover(b.driverName,function(a,j){var k=[];return a?(d.error("[init] discover err",a),f()):l.isEmpty(j.new)?(d.info("[init] discover none"),f()):(l.forEach(j.new,function(a){var j,f=a.id;return l.contains(e,f)?(d.debug("[init] already registered",f),!0):b.model&&b.model!==a.model||b.network!==a.device.sensorNetwork?(d.debug("[init] mismatch model or network",f,b,JSON.stringify(a,null,2)),!0):(j=l.clone(b,!0),j.reqId=f,j.name=b.type+"_"+i.unique(f),j.owner=o.id,j.ctime=Date.now(),j.series=f,j.address=a.device.address,a.options&&(j.options=a.options,a.options.name&&(j.name=a.options.name,delete a.options.name)),h.commands&&(j.commands=l.isObject(h.commands)?h.commands[a.model]:h.commands),j.deviceId=c.id?c.id:g.idTemplate?I(g.idTemplate,{gatewayId:j.owner,deviceAddress:j.address}):f,k.push(j),void e.push(f))}),d.debug("[init] post sensors",k),l.size(k)>0?void n.eachSeries(k,function(a,b){H.postItem(a,function(a){return a?d.error("[sensors] init - error with Sensors.postItem",a):d.info("[sensors] init - success with Sensors.postItem"),b()})},function(){var a=l.unique(l.pluck(k,"deviceId")),b=l.difference(a,o.devices);d.info("[sensors] init - creating devices",a,b),n.eachSeries(b,function(a,b){var e={reqId:a,name:a,model:c.model};p.upsertDevice(a,e,function(c){return c?d.error("[sensors] init - error on creating a device: ",a):d.info("[sensors] init - success on creating a device: ",a),b(c)})},f)}):f())}):(d.debug("[init] non discoverable sensor",b,h.discoverable),f())},function(a){return a&&d.error("[sensors] init - adding unregistered sensors error - deviceModel.sensors",a),f(a)}):(d.warn("[sensors/init] - No Device model",c.model),f())},function(a){return a&&d.error("[sensors] init - adding unregistered sensors error - Gateway.deviceModels",a),c(a)})}],function(a,b){a?d.error("[sensors] init - adding unregistered sensors error",a):d.info("[sensors] init done",b)}),d.warn("... Start gathering data - REPORT_INTERVAL(%s) ...",o.reportInterval),setTimeout(function(){setInterval(H.mqttPublishAll,o.reportInterval)},A+5e3),a&&a())}}),c.register("./server.js",function(a,b,c){"use strict";var g,h,i,j,k,l,m,n,o,p,q,r,s,d=c("log4js").getLogger("Server"),e=c("config"),f=c("lodash");e=c("config"),g=c("http"),h=c("fs"),i=c("async"),j=c("request"),k=c("querystring"),l=c("./utils"),m=c("./remotecontroller"),n=c("./store"),o=c("./mqtt"),p=l.statusError,q=l.monitor,r=e.Server&&e.Server.timeSyncCheckInterval||6e4,s=a.exports={config:{mqtt:e.Server.mqtt,service:e.Server.service},requestOptions:{json:!0,timeout:6e4},status:{mqtt:{connected:!1,lastError:""},service:{connected:!1,lastError:""}},baseUrl:null,gatewayUrl:null,gatewayId:null,registered:!1,timeSynced:!1,apiKey:null},q.on("mqtt",function(a){switch(a){case"connected":s.status.mqtt.connected=!0;break;case"close":case"error":s.status.mqtt.connected=!1}}),s.isConnected=function(a){return"mqtt"===a?this.status.mqtt.connected:this.registered&&this.status.service.connected},s.init=function(a,b,c){s.registered=!0,"https"===e.Server.service.protocol?b&&b.password?(s.requestOptions.headers={username:a,apikey:b.password},s.requestOptions.rejectUnauthorized=!1,s.apiKey=b.password):h.existsSync(e.Gateway.CERT_FILE_PATH)?(s.requestOptions.pfx=h.readFileSync(e.Gateway.CERT_FILE_PATH),s.requestOptions.passphrase=a,s.requestOptions.rejectUnauthorized=!0):s.registered=!1:"http"===e.Server.service.protocol&&(s.requestOptions.headers={gateway:a}),s.gatewayId=a,s.baseUrl=e.Server.service.protocol+"://"+e.Server.service.host+("80"===e.Server.service.port||b&&b.password?"":":"+e.Server.service.port),s.gatewayUrl=s.baseUrl+"/api/gateways/"+a,s.timeSynced=!1,function f(){l.isValidTime()?(n.timeSync(),s.timeSynced=!0,q.emit("time","synced")):setTimeout(f,r)}(),s.timeSynced||d.warn("time: NOT IN SYNC"),s.statusUpdate(function(a){return a&&d.warn("error Sever.update on init",a),c&&c()})},s._getGateway=function(a,b){var c=s.gatewayUrl;a&&(c+="?"+k.stringify(a)),j.get(c,f.clone(s.requestOptions),function(a,c,d){return a?b&&b(a):2!==Math.floor(c.statusCode/100)?b&&b(p(c.statusCode)):b&&b(null,d)})},s.getGateway=function(a,b){return s.isConnected()?s._getGateway(a,b):b&&b(p(403,"registration is required or not connected"))},s.putGateway=function(a,b){var c,e={};return s.isConnected()?(d.info("putGateway ",a),a.reportInterval&&(c=Number(a.reportInterval,10),delete a.reportInterval),void i.series([function(b){return f.isEmpty(a)?b():void j.put(s.gatewayUrl,f.extend({body:a},s.requestOptions),function(a,c,f){return a||2!==Math.floor(c.statusCode/100)?(d.error("putGateway err=",a||p(c.statusCode)),b(a||p(c.statusCode))):(e=f,void b())})},function(a){return f.isNull(c)||f.isUndefined(c)?a():void j.post(s.baseUrl+"/api/manageGateway",f.extend({body:{id:s.gatewayId,act:"setProperty",params:{reportInterval:c}}},s.requestOptions),function(b,f){return b||2!==Math.floor(f.statusCode/100)?(d.error("manageGateway err=",b||f.statusCode),a(b||p(f.statusCode))):(e||(e={}),e.reportInterval=c,void a(null))})}],function(a){return a?d.error("putGateway result err=",a):d.info("putGateway result",e),b&&b(a,e)})):b&&b(p(403,"registration is required or not connected"))},s.statusUpdate=function(a){var b=this;return s.registered?void i.forEachSeries(Object.keys(this.config),function(a,c){var f,e=b.config[a];return 0===e.protocol.indexOf("mqtt")?(f=o&&o.getStatus(),s.status[a].connected=f&&f.connected||!1,c()):0!==e.protocol.indexOf("http")?(d.error("Unknown Server"),c()):void s._getGateway(null,function(b,d){var e;if(b){if(s.status[a].connected=!1,b.statusCode)e="Gateway - "+g.STATUS_CODES[b.statusCode];else switch(b.message){case"mac verify failure":e="Certificate is not for this gateway";break;default:e=""+b}s.status[a].lastError=e}else d&&(s.status[a].connected=!0);return c()})},function(c){return f.each(b.config,function(a,b){d.info("[%s] - %s",b,s.status&&s.status[b].connected?"CONNECTED":"DISCONNECTED")}),a&&a(c)}):a(Error("need registration"))},s.upsertSensor=function(a,b,c){var e;i.series([function(c){b.reqId||(b.reqId=a),j.post(s.gatewayUrl+"/sensors",f.extend({body:b},s.requestOptions),function(g,h,i){if(g||409!==h.statusCode){if(g||2!==Math.floor(h.statusCode/100))return d.error("post Sensor failure",a,g||h.statusCode),c(g||h.statusCode);d.debug("upsert(post) sensor",i),e=i,c()}else delete b.reqId,j.put(s.gatewayUrl+"/sensors/"+a,f.extend({body:b},s.requestOptions),function(b,f,g){return b||2!==Math.floor(f.statusCode/100)?(d.error("put Sensor failure",a,b||f.statusCode),c(b||p(f.statusCode))):(d.debug("upsert(put) sensor",g),e=g,c())})})}],function(a){return a&&d.error("upsert sensor",a),c&&c(a,e)})},s.delSensor=function(a,b){return s.isConnected()?void i.series([function(b){j.del(s.gatewayUrl+"/sensors/"+a,f.clone(s.requestOptions),function(c,e){return c||2!==Math.floor(e.statusCode/100)?(d.error("del Sensor failure",c||e.statusCode),b(c)):(d.info("del sensor",a),b())})}],function(a,c){return a&&d.error("del sensor",a),b&&b(a,f.last(c))}):b&&b(p(403,"registration is required or not connected"))},s.upsertDevice=function(a,b,c){i.series([function(c){b.reqId||(b.reqId=a),j.post(s.gatewayUrl+"/devices",f.extend({body:b},s.requestOptions),function(e,g,h){if(e||409!==g.statusCode){if(e||2!==Math.floor(g.statusCode/100))return d.error("post Sensor failure",a,e||g.statusCode),c(e);d.debug("upsert(post) sensor",h),c()}else delete b.reqId,j.put(s.gatewayUrl+"/devices/"+a,f.extend({body:b},s.requestOptions),function(b,e,f){return b||2!==Math.floor(e.statusCode/100)?(d.error("put Device failure",a,b||e.statusCode),c(b||p(e.statusCode))):(d.debug("upsert(put) device",f),c())})})}],function(a){return a&&d.error("upsert device",a),c&&c(a)})},s.postCert=function(a,b){var f,c=a.buffer;if(a.size<=0)return f="No Cert",d.warn(f),b&&b(p(400,f));if(a.mimetype&&"application/x-pkcs12"!==a.mimetype&&"application/octet-stream"!==a.mimetype||a.headers&&a.headers["content-type"]&&"application/x-pkcs12"!==a.headers["content-type"]&&"application/octet-stream"!==a.headers["content-type"])return f="Invalid Cert",d.warn(f,a),b&&b(p(400,f));try{h.unlinkSync(e.Gateway.CERT_FILE_PATH)}catch(g){}h.writeFile(e.Gateway.CERT_FILE_PATH,c,function(a){return a?(d.error("cert create error",a),f="Invalid filename",b&&b(p(400,f))):(s.registered=!0,"https"===e.Server.service.protocol||"mqtts"===e.Server.mqtt.protocol?(f="Upload Success and Restarting app now",setTimeout(function(){m.process("restart")},2e3)):f="Upload Success",b&&b(null,f))})},s.postAPIKey=function(a,b){var c;return a?(e.Server.APIKEY=a,s.registered=!0,"https"===e.Server.service.protocol||"mqtts"===e.Server.mqtt.protocol?(c="Upload Success and Restarting app now",setTimeout(function(){m.process("restart")},2e3)):c="Upload Success",b&&b(null,c)):(c="No API Key",d.warn(c),b&&b(p(400,c)))},s.getSensorDrivers=function(a){var b=s.baseUrl;b+="/api/sensorDrivers",d.info("[getSensorDrivers] url",b),j.get(b,f.clone(s.requestOptions),function(b,c,e){return d.debug("[getSensorDrivers] body",b,e),b?a&&a(b):2!==Math.floor(c.statusCode/100)?a&&a(p(c.statusCode)):a&&a(null,e)})},s.getAPIKey=function(){return s.apiKey},s.getGatewayModel=function(a,b){var c=s.baseUrl;c+="/api/gatewayModels/"+a,d.info("[getGatewayModels] url",c),j.get(c,f.clone(s.requestOptions),function(a,c,e){return d.debug("[getGatewayModels] body",a,e),a?b&&b(a):2!==Math.floor(c.statusCode/100)?b&&b(p(c.statusCode)):b&&b(null,e)})}}),c.register("./store.js",function(a,b,c){"use strict";function I(){var b,a=f.freemem()/f.totalmem()*100;k.info("Memory %s%[%s/%s] limit: %s%",a,f.freemem(),f.totalmem(),w),w&&w>a?(k.fatal("Disable storing data due to memory full(%d, %d)",a,w),H.memFull=!0):H.memFull=!1,j.check(s,function(a,b,c,d){"READY"===d&&b&&u>c/b*100?(k.warn("Filesystem full %s/%s < %s%",c,b,u),g.readdir(r,function(a,b){a||i.isEmpty(b)||(i.each(b,function(a){if(a.match(/^device_\S+\.log.+/)){try{g.unlinkSync(r+a)}catch(b){k.warn("Delete log file failure",b)}k.warn("Delete logs due to filesystem full",a)}}),j.check(t,function(a,b,c,d){"READY"===d&&b&&v>c/b*100?(k.fatal("Disable storing data due to filesystem full(%d < %d)",c/b*100,v),H.fsFull=!0):H.fsFull=!1}))})):(k.info("Filesystem %s/%s > %s%",c,b,u),H.fsFull=!1)}),b=process.uptime(),b>x&&H.getFirst(function(a,c){i.each(c.message,function(a){var c=a,d=c&&(i.isArray(c)?i.first(c):c);d&&d.b&&d.u&&(d.b!==z||d.u<1e3*(b-x))&&(k.error("Detected too old data, oldest=%j",d,a),k.error("msg.u[%d] < ((uptime - REBOOT_IN_OFFLINE_INTERVAL)[%d] *1000)",d.u,b-x),l.emit("store","tooold",a,H.size()))})}),setTimeout(I,p)}function J(){0===G.size()&&D&&(G.clean(),C=1,D=!1,setTimeout(function(){D=!0},p))}var y,z,B,C,D,E,F,G,H,d=c("mkdirp"),e=c("dirty"),f=c("os"),g=c("fs"),h=c("path"),i=c("lodash"),j=c("diskspace"),k=c("log4js").getLogger("Store"),l=c("./utils").monitor,m=c("config"),n=m.Store&&m.Store.baseDir||"/var/lib/thingplus/",o=m.Store&&m.Store.currentFile||"db.dirty",p=m.Store&&m.Store.cleanUpInterval||36e5,q="/proc/sys/kernel/random/boot_id",r=m.Gateway&&m.Gateway.logBaseDir||"/var/log/thingplus/",s=m.Gateway&&m.Gateway.logBaseDirMountPoint||"/",t=m.Gateway&&m.Gateway.storeBaseDirMountPoint||"/",u=m.Store&&m.Store.logFlushFilesystemLimit||10,v=m.Store&&m.Store.storeDisableFilesystemLimit||3,w=m.Store&&m.Store.storeDisableMemoryLimit||0,x=m.Store&&m.Store.rebootInOfflineInterval||86400;try{z=parseInt(g.readFileSync(q).slice(0,8),16).toString(36)}catch(A){}B=!1,C=0,D=!0,E={},F=!1,H=a.exports={},H.fsFull=!1,H.memFull=!1,H.isPersistent=!1,H.init=function(b){if(B)return b&&b();B=!0;try{if(m.Store.memoryOnly)throw k.warn("memory only mode"),Error("memory only mode");if(!z)throw k.warn("no bootId, os=",f.platform()),z="none",Error("no bootid");d.sync(n),G=e(h.join(n,o)),H.isPersistent=!0}catch(c){k.error("use memory db instead due to persistent db failure",c),G=e(),H.isPersistent=!1}["forEach","size"].forEach(function(b){a.exports[b]=G[b].bind(G)}),G.on("error",function(a){k.error("error on loading",a)}),G.on("load",function(){return C=Number(G.getLastKey(),10)||0,C++,J(),I(),b&&b()})},H.encode=function(a){if(F){var b=!1,c={};return i.each(a.message,function(a,d){var e=a;e=e&&(i.isArray(e)?e:[e]),i.each(e,function(a){!a.t&&a.b&&a.u&&E[a.b].d&&(a.t=a.u+E[a.b].d),i.isObject(a.v)&&(b=!0)}),c||(c={}),c[d]=i.flatten(i.zip(i.pluck(e,"t"),i.pluck(e,"v")))}),{topic:a.topic,message:JSON.stringify(c)}}},H.getFirst=function(a){var b=G.getFirstKey();return b?a(b,G.get(b)):void 0},H.getLast=function(a){var b=G.getLastKey();return b?a(b,G.get(b)):void 0},H.forEach=function(a){G.forEach(a)},H.push=y=function(a){return H.memFull||H.fsFull?void k.error("push failure due to resource limit"):(i.each(a.message,function(a){var b=a;i.each(b&&(i.isArray(b)?b:[b]),function(a){a&&a.u&&!a.b&&(a.b=z)})}),G.set(C++,a),void l.emit("store","new"))},H.rm=function(a){G.rm(a),J()},H.timeSync=function(){var b,c,d,a=[];E[z]||(d=Date.now(),c=parseInt(1e3*f.uptime(),10),E[z]={u:c,d:d-c}),G.forEach(function(b,c){i.each(c.message,function(b){var c=b,d=c&&(i.isArray(c)?i.last(c):c);E[d.b]||(E[d.b]={}),k.debug("timeSync: before",E[d.b]),d.t&&(E[d.b].d||(E[d.b].d=d.t-d.u)),E[d.b].u=d.u,a.length&&i.last(a)===d.b||a.push(d.b),k.debug("timeSync: after",E[d.b]),k.debug("timeSync: bootArr",a)})}),i.last(a)!==z&&k.info("timeSync: [%s] %s + [%s]",z,new Date(E[z].d).toISOString(),E[z].u/1e3),b=E[z],i.eachRight(a,function(a){E[a].d||(E[a].d=b.d-E[a].u),b=E[a],k.info("timeSync: [%s] %s + [%s]sec",a,new Date(E[a].d).toISOString(),E[a].u/1e3)}),F=!0}}),c.register("./utils.js",function(a,b,c){"use strict";function j(){d.EventEmitter.call(this)}function n(a){return(""+a).replace(/[:-]/g,"").toLowerCase()}function o(a,b){var c;switch(a||(a="mac"),a){case"mac":if(k)return b(null,k);i(function(a,d){return!a&&d&&(c=(""+d).replace(/[:-]/g,"").toLowerCase(),k=c),b(a,c)});break;case"mac+filesystem":if(l)return b(null,l);g("blkid -t LABEL=rootfs -s UUID -o value",{timeout:5e3,killSignal:"SIGKILL"},function(a,d){return!a&&d&&(c+=(""+d).trim(),c.replace(/-/g,""),c=parseInt(c,16).toString(36),l=c),b(a,c)});break;case"bbbserial":if(m)return b(null,m);g("hexdump -e '8/1 \"%c\"' /sys/bus/i2c/devices/0-0050/eeprom -s 16 -n 12",{timeout:5e3,killSignal:"SIGKILL"},function(a,d){return!a&&d&&(c=(""+d).trim(),m=c),b(a,c)});break;default:return b(Error("unknown type",a))}}var k,l,m,p,d=c("events"),e=c("log4js").getLogger("Utils"),f=c("util"),g=c("child_process").exec,h=c("async"),i=c("getmac").getMac;f.inherits(j,d.EventEmitter),a.exports.monitor=new j,a.exports.statusError=function(a,b){var c=Error(b?a+" "+b:""+a);return c.statusCode=a,c},a.exports.isValidTime=function(a){return a||(a=Date.now()),a>1388502e6},a.exports.getSafeId=n,a.exports.getId=o,a.exports.getBoardInfo=function(a){if(p)return a(null,p);p={};var b=setTimeout(function(){return e.error("[getBoardInfo] blocked",p),b=null,a&&a(null,p)},1e3);h.series([function(a){o("mac",function(b,c){return!b&&c&&(p={macaddress:c}),a()})},function(a){g("hexdump -e '8/1 \"%c\"' /sys/bus/i2c/devices/0-0050/eeprom -s 4 -n 24",{timeout:5e3,killSignal:"SIGKILL"},function(b,c){if(!b&&c){var d=(""+c).trim();p.model=d.substring(0,8),p.rev=d.substring(8,12),p.serial=d.substring(12,24)}return a()})},function(a){return!p.model&&process.env.MODEL&&(p.model=process.env.MODEL),!p.serial&&process.env.SN&&(p.serial=process.env.SN),a()}],function(c){return b?(clearTimeout(b),b=null,a&&a(c,p)):void e.error("[getBoardInfo] timeout",p)})}}),b.exports=c("./app.js")}(require,module);
